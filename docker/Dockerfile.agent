# Multi-stage Dockerfile for SAM Agent
# Supports dev, prod-cpu, prod-gpu profiles
# Deterministic, reproducible builds

ARG PYTHON_VERSION=3.11
ARG BASE_IMAGE=python:${PYTHON_VERSION}-slim

# Build arguments for profile selection
ARG PROFILE=dev
ARG INSTALL_WHISPER=false
ARG INSTALL_COQUI=false
ARG INSTALL_CUDA=false

# ============================================================================
# Stage 1: Builder - Install all dependencies
# ============================================================================
FROM ${BASE_IMAGE} AS builder

ARG PYTHON_VERSION
ARG INSTALL_WHISPER
ARG INSTALL_COQUI

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    sqlite3 \
    && rm -rf /var/lib/apt/lists/*

# Create virtual environment
RUN python${PYTHON_VERSION} -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Copy requirements
COPY pyproject.toml /tmp/
WORKDIR /tmp

# Install core dependencies
RUN pip install --no-cache-dir -e .

# Install optional components based on profile
RUN if [ "$INSTALL_WHISPER" = "true" ]; then \
    pip install --no-cache-dir openai-whisper; \
    fi

RUN if [ "$INSTALL_COQUI" = "true" ]; then \
    pip install --no-cache-dir TTS; \
    fi

# Install gTTS for text-to-speech voice replies
RUN pip install --no-cache-dir gtts

# ============================================================================
# Stage 2: Base Runtime (CPU)
# ============================================================================
FROM ${BASE_IMAGE} AS runtime-cpu

ARG PYTHON_VERSION

# Install runtime system dependencies only
RUN apt-get update && apt-get install -y --no-install-recommends \
    libopenblas-dev \
    libgomp1 \
    curl \
    sqlite3 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 agent

# Copy virtual environment from builder
COPY --from=builder --chown=agent:agent /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Set working directory
WORKDIR /app
RUN chown -R agent:agent /app

# Copy agent code
COPY --chown=agent:agent . /app/

# Create data directory for SQLite
RUN mkdir -p /app/data && chown -R agent:agent /app/data

# Switch to non-root user
USER agent

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/health/live || exit 1

# Default environment
ENV PYTHONPATH=/app \
    LLM_BACKEND=stub \
    STT_ENABLED=false \
    TTS_ENABLED=false \
    LTM_BACKEND=stub \
    DATABASE_PATH=/app/data/memory.db

# Entrypoint
ENTRYPOINT ["python", "-m", "agent.api"]
CMD ["--host", "0.0.0.0", "--port", "8000"]

# ============================================================================
# Stage 3: GPU Runtime
# ============================================================================
FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04 AS runtime-gpu

ARG PYTHON_VERSION=3.11

# Install Python and runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-venv \
    libopenblas-dev \
    libgomp1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 agent

# Copy virtual environment from builder (built with CPU, will run on GPU)
COPY --from=builder --chown=agent:agent /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    CUDA_VISIBLE_DEVICES=0

# Set working directory
WORKDIR /app
RUN chown -R agent:agent /app

# Copy agent code
COPY --chown=agent:agent . /app/

# Create data directory for SQLite
RUN mkdir -p /app/data && chown -R agent:agent /app/data

# Switch to non-root user
USER agent

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8000/health/live || exit 1

# Default environment (GPU-aware)
ENV PYTHONPATH=/app \
    LLM_BACKEND=stub \
    STT_ENABLED=false \
    TTS_ENABLED=false \
    LTM_BACKEND=stub \
    DATABASE_PATH=/app/data/memory.db \
    WHISPER_DEVICE=cuda \
    COQUI_DEVICE=cuda

# Entrypoint
ENTRYPOINT ["python", "-m", "agent.api"]
CMD ["--host", "0.0.0.0", "--port", "8000"]

# ============================================================================
# Final stage: Image metadata (applies to all profiles)
# ============================================================================
FROM runtime-cpu AS final-base

# Image metadata
ARG PROFILE=dev
ARG GIT_COMMIT=unknown
ARG BUILD_DATE=unknown

LABEL org.opencontainers.image.title="SAM Agent" \
      org.opencontainers.image.version="0.0.1" \
      org.opencontainers.image.description="Stateful Agent Model - Production-oriented AI agent system" \
      org.opencontainers.image.url="https://github.com/SameulAH/SAM-Agent-WhatsApp" \
      org.opencontainers.image.vendor="SAM Team" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.profile="${PROFILE}"

# Final metadata logging
RUN echo "SAM Agent Image" && \
    echo "Profile: ${PROFILE}" && \
    echo "Git Commit: ${GIT_COMMIT}" && \
    echo "Built: ${BUILD_DATE}" && \
    python -c "import sys; print(f'Python: {sys.version}')"

# ============================================================================
# Final GPU stage (if PROFILE=prod-gpu)
# ============================================================================
FROM runtime-gpu AS final-gpu

# Image metadata
ARG PROFILE=prod-gpu
ARG GIT_COMMIT=unknown
ARG BUILD_DATE=unknown

LABEL org.opencontainers.image.title="SAM Agent" \
      org.opencontainers.image.version="0.0.1" \
      org.opencontainers.image.description="Stateful Agent Model - GPU-accelerated" \
      org.opencontainers.image.url="https://github.com/SameulAH/SAM-Agent-WhatsApp" \
      org.opencontainers.image.vendor="SAM Team" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.profile="${PROFILE}"

# Final metadata logging
RUN echo "SAM Agent Image (GPU)" && \
    echo "Profile: ${PROFILE}" && \
    echo "Git Commit: ${GIT_COMMIT}" && \
    echo "Built: ${BUILD_DATE}" && \
    python -c "import sys; print(f'Python: {sys.version}')"
